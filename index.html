<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">

<head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-array.v2.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
    crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/d3-geomap@3.3.0/dist/d3-geomap.min.css"/>
    <link rel="stylesheet" href="css/styles.css"> 
    <link rel="stylesheet" href="css/aos.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:300,400,700,900&display=swap" rel="stylesheet">
    <!-- <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,700,900&display=swap" rel="stylesheet"> -->

    <script type="text/javascript" src= "https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore.js"></script> 
    <script src="https://unpkg.com/topojson@3/dist/topojson.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-geomap@3.3.0/dist/d3-geomap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js" integrity="sha512-wNH6xsp2n8CfB91nrBtfc4sfLwYPBMjSWVUwQOp60AYYXH6i8yCwuKFZ4rgK2i6pQek/b+bSyR7b01/922IBzQ==" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
    <script src="./index.js"></script>
    <script src="./libraries/color-legend.js"></script>
    <script src="libraries/scroller.js"></script>
    <script src="libraries/sections.js"></script>
</head>

<body>
    <!-- nav dots -->
    <nav id="cd-vertical-nav">
        <ul>
            <li><a href="#section1" data-number="1"><span class="cd-dot"></span><span class="cd-label">Home</span></a></li>
            <li><a href="#section2" data-number="2"><span class="cd-dot"></span><span class="cd-label">Grid Map</span></a></li>
            <li><a href="#section3" data-number="3"><span class="cd-dot"></span><span class="cd-label">Analysis</span></a></li>
        </ul>
    </nav>

    <!-- Grid Map -->
    <section id = "section1" class="cd-section nav-section" style="background-image: url('data/home.png'); 
    background-position: center bottom; background-repeat: no-repeat; background-size: cover; padding-top: 35vh; padding-bottom: 35vh;
    padding-left: 9%;">
        <div data-aos="fade-in">
            <h2>US FATAL SHOOTING</h2>
            <h2 class="cursive">BY POLICE</h2><br>
            <div style="padding-right: 60vw;" data-aos="fade-in">
                <p style="text-align: left;font-size: 17px;">"When you shoot, you shoot to kill. Using your gun is the last resort."<em><br><br>- A police officer</em></p>
            </div>
        </div>
    </div>
    </section>
    <section id="section2" class="nav-section cd-section">
        <div class="container">
            <!-- heading text -->
            <div class="heading">
                <div class="header"> US Fatal Shooting by Police</div>
                <div class="subheader"> This dataset is about every fatal shooting in the United States by a police officer in the line of duty since 2015.
                    A death is not just a statistic figure, it's a life that once lived in this world.
                    The importance of data for people who have died should not be diminished. 
                    <br><br>
                    <div style="display: flex; align-items: stretch;color: var(--red2)">
                        <span>>> Explore more information about killed citizens per year by dragging the slider</span>
                        <div id="filter-year" style="padding-left: 30px;display: flex; align-items: stretch;">
                            <input id="year-filter" type="range" class="custom-range" value="2015" min="2015" max="2019" step="1" v-model="year">
                            <text id="year-selected" style="padding-left: 10px">2015</text>
                        </div>
                    </div>
                </div>
            </div>

            <!-- two charts -->
            <div class="grid">
                <div class="info">
                    <div class="tooltippp" style = "margin-left: 1%; position:absolute"></div>
                    <div class="tooltipState" style="margin-left: 68%"></div>
                </div>

                <div class="container-fluid">
                    <div class="row">
                        <div class="col-sm-5" style="padding-left: 0px" id="grids">
                            <div>>> Hover a dot to discover personal information</div>
                            <br/>
                        </div>
                        <div class="col-sm-7 d3-geomap" style="padding-right: 0px; text-align: center;" id="mappppp">
                            <div>>> Click the state to view more information</div>
                            <div class="row justify-content-center" style="margin-bottom: -18px;"> 
                                <svg id="legendddd"></svg>
                            </div>
                            
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </section>
    

    <!-- Details -->
    <section id="section3" class="cd-section nav-section">
        <div class="container">
            <div id="storyTitle">Here is the beginning of the analysis >> </div>
        	<div id='graphic'>
                
                <div id='vis'><div id='vislegend'></div></div>
            	<div id='sections'>
                 <section class="step">
                    <div class="title">There are 1002 fatal police shootings in 2019.</div>
                  </section>
             	  <section class="step">
	                <div class="title">Was the gun involved? </div>
	                The right figure shows that over half of these cases have seen an involvement of a gun. The U.S. has a high rate of deaths from gun violence. It threatens our life and makes policing be a really tough job.
	              </section>
	              <section class="step">
	                <div class="title">How old are they? </div>
	                The majority of the people who were killed are over 20. But we can see the young age people constitute about a half of the deaths. It is a sad fact that teenagers were killed in fatal by the police.
	              </section>
	              <section class="step">
	                <div class="title">Were they fleeing?</div>
	                It is interesting that more than 1/2 of the people were not fleeing when they were killed. <br/><br/> In this situation, do the police officers really need to kill them? 
	              </section>
                </div>
                  <div id="extra-space"></div>
        	</div>
    	</div>
    </section>

    <section id="section00">
        <div class="container">
            <div class="line"></div>
            <div class="row">
                <div class="col-md-6">
                    <p class="small">
                        Data Sources:
                        <br>Police Shootings Dataset: <a href = "https://www.kaggle.com/mrmorj/data-police-shootings">DS Dataset</a>
                        <br>Police Violence & Racial Equity Dataset: <a href = "https://www.kaggle.com/jpmiller/police-violence-in-the-us">RV&RE Dataset</a>
                        <br>Video: <a href = "https://www.youtube.com/watch?v=1ttZ7L2pWNo">A4 Video</a>
                    </p>
                </div>
                <div class="col-md-6">
                    <p class="small" style="text-align: right;"><b >MIT 6.859 : Data Visualization</b><br>by Rui Wang, <br>Jiahui Tang, <br>and Silin Zou</p>
                </div>
            </div>
        </div>
        <div id="extra-space"></div>
    </section>

    <!-- Render script -->
    <script>
        document.getElementById("year-filter").addEventListener("input", e=>{
            let year = e.target.value;
            document.getElementById("year-selected").innerHTML = year;
            console.log(e.target.value);
            render();
            scroll_display();
        });

        const stateCodeToFips =
            {"AK": "02", "AL": "01", "AR": "05", "AS": "60", "AZ": "04", "CA": "06", "CO": "08", "CT": "09", "DC": "11",
                "DE": "10", "FL": "12", "GA": "13", "GU": "66", "HI": "15", "IA": "19", "ID": "16", "IL": "17",
                "IN": "18", "KS": "20", "KY": "21", "LA": "22", "MA": "25", "MD": "24", "ME": "23", "MI": "26",
                "MN": "27", "MO": "29", "MS": "28", "MT": "30", "NC": "37", "ND": "38", "NE": "31", "NH": "33",
                "NJ": "34", "NM": "35", "NV": "32", "NY": "36", "OH": "39", "OK": "40", "OR": "41", "PA": "42",
                "PR": "72", "RI": "44", "SC": "45", "SD": "46", "TN": "47", "TX": "48", "UT": "49", "VA": "51",
                "VI": "78", "VT": "50", "WA": "53", "WI": "55", "WV": "54", "WY": "56"};

        const fipsToStateCode = Object.entries(stateCodeToFips).reduce((ret, entry) => {
            const [ key, value ] = entry;
            ret[ value ] = key;
            return ret;
        }, {});

        const squareSize = 9; // length of a side of a square
        const strokeWidth = 1.3;
        const numPerRow = 30;
        const numPerCol = 34;
        const w = (squareSize + (strokeWidth * 2)) * numPerRow; // width of chart
        const h = (squareSize + (strokeWidth * 2)) * numPerCol; // height of chart
        const margin = {
            top: 5,
            right: 5,
            bottom: 5,
            left: 5,
        }

        var myColor = d3.scaleSequential()
        .interpolator(d3.interpolateReds) // color
        .domain([0, 200]);

        legend({color: myColor, width: 330, svgIn: d3.select('#legendddd')});// title: "Number of Killed Citizens",

        var Ordinalcolor = d3.scaleOrdinal(d3.schemeCategory10);

        var Fourcolor = d3.scaleOrdinal(d3.schemeCategory10)
                           .domain(["unknown", "40","20","0"]) ;

        // Create scale
        const scale = d3.scaleLinear()
        .domain([0, numPerRow])
        .range([0, w]);

        // Create the svg
        var svg = d3.select("#grids").append('svg')
        .attr('class', 'chart')
        .attr('width', w + margin.left + margin.right)
        .attr('height', h + margin.top + margin.bottom)
        var chart = svg.append('g')
        .attr('transform', `translate(${margin.left}, ${margin.top})`)

        // create div for tooltip
        var tooltip = d3.select(".tooltippp")
        .style("opacity", 0);

        var tooltipState = d3.select(".tooltipState")
        .style("opacity", 0);

        // create map
        var map = d3.choropleth()
        .geofile('https://cdn.jsdelivr.net/npm/d3-geomap@3.3.0/dist/topojson/countries/USA.json')
        .projection(d3.geoAlbersUsa)
        .height(h + margin.top + margin.bottom)
        .column('count')
        .unitId('fips')
        .scale(800)
        .legend(false);

        /*
         * Function of the scrollytelling 
         */
        function scroll_display(){
            d3.csv('data/death-by-police.csv').then(function (data){
                 display(data);
             });
        }


        /**
         * Render the data into the visualization layout.
         */
         function render() {
            d3.csv("data/death-by-police.csv").then(function (raw_data) {
                
                let year = document.getElementById("year-filter").value;
                let data = raw_data.filter(d=>d.date.substring(0,4)==year);

                let countByState = d3.rollup(data, v => v.length, d => d.state); //count of each state
                data.sort((a, b) => d3.descending(countByState.get(a.state), countByState.get(b.state)) == 0
                ? d3.descending(a.state,b.state):d3.descending(countByState.get(a.state), countByState.get(b.state))); // sort by count

                data.map(d => d.age === '' ? d.age ='Unknown': d.age);
                data.map(d => d.gender === 'F' ? d.gender ='Female': d.gender ='Male');
                
                chart.selectAll('rect').remove();

                // Append new squares
                const squares = chart.selectAll('rect')
                .data(data, function (d) { return d.name; })

                squares.enter().append('rect')
                .attr('x', (d, i) => {
                    const n = i % numPerRow;
                    return scale(n);
                })
                .attr('y', (d, i) => {
                    const n = Math.floor(i / numPerRow);
                    return scale(n);
                })
                .attr('fill', d => myColor(countByState.get(d.state)))//d => myColor(countByState.get(d.state))
                .attr('ry', 10)
                .attr('rx', 10)
                .attr('width', squareSize)
                .attr('height', squareSize)
                .on("mouseover", handleMouseOver)
                .on("mouseout", handleMouseOut)
                .transition().delay(function (d, i) { return .9 * i; })
                .attr("class", (d) => { return d.state; });



                function handleMouseOver(d) {
                    // highlight rect 
                    d3.select(this).attr('opacity', '40%');
                    tooltip.transition()
                    .duration(30)
                    .style("opacity", 1)
                    tooltip.html("Age: " + d.age + "<br>Gender: " + d.gender + "<br>Location: " + d.city + ", "+ d.state + "<br>Flee: " + d.flee)
                    .style("color", myColor(countByState.get(d.state)));

                    d3.select('.unit-US' + stateCodeToFips[d.state]).classed("map-state-highlighted", true);
                }

                function handleMouseOut(d) {
                    // unhighlight color
                    d3.select(this).attr('opacity', '100%');
                    tooltip.transition()
                    .duration(30)
                    .style("opacity", 0);

                    d3.select('.unit-US' + stateCodeToFips[d.state]).classed("map-state-highlighted", false);
                }

                // Map to Grid
                const mapData = d3.rollups(data, v => v.length, d => d.state).map(([k, v]) => {return {fips: "US"+stateCodeToFips[k], count: v}}); // return {fip, count}
                
                d3.selectAll('.unit').remove(); // remove
                d3.select('#mappppp>svg').remove();

                let stateSelected = false;
                let arrayOfSelected = []; // an array containing all selected states

                function selectState(d) {
                    stateSelected = true;

                    const stateName = fipsToStateCode[d.properties.fips.slice(2)];

                    // if (!arrayOfSelected.includes(stateName)){ 
                    //     //add state into array
                    //     arrayOfSelected.push(stateName);
                    // }else{
                    //     //remove state from array
                    //     let i = arrayOfSelected.indexOf(stateName); 
                    //     if (i===0)
                    //     {arrayOfSelected=[]}
                    //     else
                    //     {arrayOfSelected.splice(i,i);};
                    // };
                    // console.log(arrayOfSelected);

                    svg.selectAll("rect")
                        .style("fill", d => myColor(countByState.get(d.state)));

                    // if (!arrayOfSelected.length) //empty array
                    // {
                    //     svg.selectAll("rect").attr('opacity', '100%');
                    //     d3.selectAll('.unit').attr('opacity', '100%');
                    // }else{
                    //     svg.selectAll("rect")
                    //     .filter(d => arrayOfSelected.includes(d.state))
                    //     .attr('opacity', '100%')
                    //     .attr('fill', d => myColor(countByState.get(d.state)));

                    //     svg.selectAll("rect")
                    //     .filter(d => !arrayOfSelected.includes(d.state))
                    //     .attr('opacity', '30%')
                    //     .attr('fill', d => myColor(countByState.get(d.state)));

                    //     d3.selectAll('.unit').filter(d2 => {arrayOfSelected.includes(fipsToStateCode[d2.properties.fips.slice(2)])}).attr('opacity', '100%');
                    //     d3.selectAll('.unit').filter(d2 => !arrayOfSelected.includes(fipsToStateCode[d2.properties.fips.slice(2)])).attr('opacity', '30%'); //d !== d2
                    // };


                    svg.selectAll("rect")
                        .filter(d => d.state !== stateName)
                        .attr('opacity', '30%')
                        .attr('fill', d => myColor(countByState.get(d.state)));
                    d3.selectAll('.unit').filter(d2 => d !== d2).attr('opacity', '50%');

                    tooltipState.transition()
                        .duration(30)
                        .style("opacity", 1)
                    tooltipState.html("<br>State: " + stateName + "<br>Deaths: " + (countByState.get(stateName) || '0'))
                                .style("color", myColor(countByState.get(stateName)));
                }

                function unselectState(d) {
                    stateSelected = false;

                    const stateName = fipsToStateCode[d.properties.fips.slice(2)];

                    d3.selectAll("rect")
                        .filter(d => d.state !== stateName)
                        .attr('opacity', '100%');

                    d3.selectAll('.unit').filter((d2) => d !== d2).attr('opacity', '100%');

                    tooltipState.transition()
                        .duration(30)
                        .style("opacity", 0);
                }

                map.postUpdate(() => {
                    d3.selectAll('.unit')
                        .style('fill', (d) => {
                            return myColor(countByState.get(fipsToStateCode[d.properties.fips.slice(2)]));
                        })
                        .on("click", (d) => {
                            if (stateSelected) {
                                unselectState(d);
                            } else {
                                selectState(d);
                            }
                            // selectState(d);
                        })
                        .on("mouseout", unselectState);
                    })
                    .draw(d3.select('#mappppp').datum(mapData)); 
                });
        }

        render();
        scroll_display();
        
    </script>
	
    <script src="libraries/popper.min.js"></script>
    <!-- AOS must be included last -->
    <script src="libraries/aos.js"></script>
    <script src="libraries/animate.js"></script>
</body>

</html>
