<!DOCTYPE html>
<html>

<head>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-array.v2.min.js"></script>
    <!-- <script src="https://d3js.org/d3.v6.min.js"></script> -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
        crossorigin="anonymous">
    <link rel="stylesheet" href="./styles.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel="stylesheet">
    <script type="text/javascript" src= "https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore.js"></script> 
</head>

<body>
    <div class="container">
        <div class="heading">
            <div class="header"> US Death by Police</div>
            <div class="subheader"> This dataset is about every fatal shooting in the United States by a police officer in the line of duty since January 1, 2015.
                A death is not just a statistic figure, it's a life that once lived in this world.
                The importance of data for people who have died should not be diminished. 
                <br><br><span style="color: white;">>> Explore more information about killed citizens by hovering over the pixels </span>
            </div>
        </div>
        <div class="separate">
            <div class="grid">
                <div class="info"></div>
            </div>
            <nav aria-label="Page navigation example">
                <ul class="pagination">
                <li class="page-item"><a class="page-link" id ="CA" href="#">CA</a></li>
                <li class="page-item"><a class="page-link" id ="TX" href="#">TX</a></li>
                <li class="page-item"><a class="page-link" id ="FL" href="#">FL</a></li>
                <li class="page-item"><a class="page-link" id ="GA" href="#">GA</a></li>
                <li class="page-item"><a class="page-link" id ="CO" href="#">CO</a></li>
                </ul>
            </nav>
            <!-- <img class="icon achievement" id="achievement" src="icons/achievement.svg" height="35" width="35"> -->
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>

    <!-- Render script -->
    <script>
        const squareSize = 9; // length of a side of a square
        const strokeWidth = 1.3;
        const numPerRow = 30;
        const numPerCol = 34;
        const w = (squareSize + (strokeWidth * 2)) * numPerRow; // width of chart
        const h = (squareSize + (strokeWidth * 2)) * numPerCol; // height of chart
        const margin = {
            top: 5,
            right: 5,
            bottom: 5,
            left: 5,
        }
        var myColor = d3.scaleSequential()
            .interpolator(d3.interpolateReds)
            .domain([-20,150]);

        // Create scale
        const scale = d3.scaleLinear()
            .domain([0, numPerRow])
            .range([0, w]);

        // Create the svg
        var svg = d3.select(".grid").append('svg')
            .attr('class', 'chart')
            .attr('width', w + margin.left + margin.right)
            .attr('height', h + margin.top + margin.bottom)
        var chart = svg.append('g')
            .attr('transform', `translate(${margin.left}, ${margin.top})`)

        // create div for tooltip
        var tooltip = d3.select(".info").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        /**
         * Render the data into the visualization layout.
         */
        function render() {
            d3.csv("data/death-by-police.csv").then(function (raw_data) {
                let data = raw_data
                    .filter(d => d.date.substring(0,4) == '2019'); // data in year 2019
                
                let countByState = d3.rollup(data, v => v.length, d => d.state); //count of each state
                data.sort((a, b) => d3.descending(countByState.get(a.state), countByState.get(b.state))); // sort by count

                data.map(d => d.age === '' ? d.age ='Unknown': d.age);
                data.map(d => d.gender === 'F' ? d.gender ='Female': d.gender ='Male');
                // console.log(newdata);
                chart.selectAll('rect').remove();

                // Append new squares
                const squares = chart.selectAll('rect')
                    .data(data, function (d) { return d.name; })

                squares.enter().append('rect')
                    .attr('x', (d, i) => {
                        const n = i % numPerRow;
                        return scale(n);
                    })
                    .attr('y', (d, i) => {
                        const n = Math.floor(i / numPerRow);
                        return scale(n);
                    })
                    .attr('fill','var(--grey1)')
                    .attr('ry', 10)
                    .attr('rx', 10)
                    .attr('width', squareSize)
                    .attr('height', squareSize)
                    .on("mouseover", handleMouseOver)
                    .on("mouseout", handleMouseOut)
                    .transition().delay(function (d, i) { return .9 * i; })
                    .attr("class", (d) => { return d.state; });


                function handleMouseOver(d) {
                    // highlight rect 
                    d3.select(this).style("fill", d => myColor(countByState.get(d.state)));
                    tooltip.transition()
                        .duration(30)
                        .style("opacity", 1)
                    tooltip.html("Age: " + d.age + "<br>Gender: " + d.gender + "<br>Location: " + d.city + ", "+ d.state + "<br>Flee: " + d.flee);
                }

                function handleMouseOut(d) {
                    // unhighlight color
                    d3.select(this).style("fill", 'var(--grey1)');
                    tooltip.transition()
                        .duration(30)
                        .style("opacity", 0);
                    d3.select(this).attr("class", null)
                }

                function updateProportions(proportions) {
                    let categories = Object.keys(proportions);
                    for (c of categories) {
                        document.getElementById("icon-proportion-" + c).innerHTML = proportions[c] + "%";
                    }
                }
            });
        }

        render();

        // Category highlighintg
        $('.page-link').on("mouseenter", function (e) {
            // console.log(hello)
            highlight($(this).attr('id'));
        });

        function highlight(category) {
            d3.selectAll("rect").attr("class", function (d) {
                return d.state + " " + (d.state == category ? "is-active" : "is-inactive");
            });
        }
        
    </script>

</body>

</html>